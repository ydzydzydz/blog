---
layout: post
title: Surge配置详解
tags: 科学上网 Surge Proxy SS Rules
categories: Surge Rules
---




[配置示例](https://github.com/ydzydzydz/Rules/blob/master/conf/zhuangzhuang/zhuangzhuang.conf)   

**使用前须在 iCloud 云盘/Surge/resources/policy/ 文件夹内创建 [auto.list](https://raw.githubusercontent.com/ydzydzydz/Rules/master/proxy/auto.list) 和 [all.list](https://raw.githubusercontent.com/ydzydzydz/Rules/master/proxy/all.list)**

[在本地新建list文件](http://zhuangzhuang.cf/2018-11-26/list/)

<!-- more -->

---
保护配置, 在Surge中不可修改
```ini
#!REQUIRE-PROTECTED
```
托管配置
```
#!MANAGED-CONFIG https://github.com/ydzydzydz/Rules/blob/master/conf/zhuangzhuang/zhuangzhuang.conf interval=86400
```

* TOC
{:toc}
---

# [General]
日志等级: warning, notify, info, verbose (默认值: notify)
```ini
loglevel = notify
```

跳过某个域名或者 IP 段, 这些目标主机将不会由 Surge Proxy 处理

(macOS 版本中, 如果启用了 Set as System Proxy,  这些值会被写入到系统网络代理设置)
```ini
skip-proxy = 127.0.0.1, 192.168.0.0/16, 193.168.0.0/24, 10.0.0.0/8, 172.16.0.0/12, 100.64.0.0/10, localhost, *.local
```
强制使用特定的 DNS 服务器
```ini
dns-server = 223.5.5.5, 119.29.29.29, 114.114.114.114, 8.8.8.8, system
```
允许外部控制器访问 Surge, Surge Dashboard 或 Surge CLI 进行管理控制
```ini
external-controller-access = passw@127.0.0.1:6170
```
是否启动完整的 IPv6 支持 (默认值: false)
```ini
ipv6 = false
```
TUN规则匹配模式 (默认值: false)

```ini
enhanced-mode-by-rule = 1
```

拒绝页面显示错误

```ini
show-error-page-for-reject = true
```

不包括简单主机名

```ini
exclude-simple-hostnames = true
```
Surge 作为 HTTP/SOCKS5 代理服务器向 Wi-Fi 网络下的其他设备提供服务器
```ini
allow-wifi-access = true
```
* Surge Mac 供外网访问的服务端口  
HTTP 代理服务端口 (默认值: 6152)
```ini
http-listen = 0.0.0.0:8888
```
SOCKS5 代理服务端口 (默认值: 6153)
```ini
socks5-listen = 0.0.0.0:8889
```
* Surge iOS 供外网访问的服务端口  
HTTP 代理服务端口 (默认值: 6152)
```ini
wifi-access-http-port = 8888
```
SOCKS5 代理服务端口 (默认值: 6153)
```ini
wifi-access-socks5-port = 8889
```

兼容模式（默认禁用）
* 禁用
```ini
compatibility-mode = 0
```
* Proxy with Loopback Address
```ini
compatibility-mode = 1
```
* Proxy Only
```ini
compatibility-mode = 2
```
* TUN Only
```ini
compatibility-mode = 3
```

启用 Network.framework (默认值: false)

```ini
network-framework = true
```

INTERNET 测试 URL (使用网络诊断功能时访问的 URL)

```ini
internet-test-url = http://wwww.gstatick.com/generate_204
```

代理测速 URL (测试代理策略时的 URL)

```ini
proxy-test-url = http://wwww.gstatick.com/generate_204
```

测速超时 (秒)

```ini
test-timeout = 5
```

强制 TCP 连接为 HTTP 连接

```ini
force-http-engine-hosts = api.joybj.com
```

---

# [Replica]
``该段定义抓取流量的过滤``

隐藏所有发往 *.Apple.com 和 *.icloud.com 的请求（该选项只是在抓取结果中隐藏了请求）
```ini
hide-apple-request = true
```
隐藏Crashlytics请求
```ini
hide-crashlytics-request = true
```
隐藏UDP会话（默认值: false）
```ini
hide-udp = false
```
使用关键词过滤器（默认值: false）
```ini
use-keyword-filter = false
```

+ 仅记录不包含关键字的请求
```ini
keyword-filter-type = blacklist
```

+ 仅记录包含关键字的请求
```ini
keyword-filter-type = whitelist
```

关键字 (例：abc def)

```ini
keyword-filter = abc,def
```



---
# [Proxy]

``该段定义可用的代理策略``

写法是：策略名 = 代理类型, 代理地址, 端口号, 用户名, 密码

不同的类型填写的具体项目会有差异, 建议在 UI 界面中填写

策略名不可重复, 策略名须先定义才能在其它部分引用
```ini
ProxyHTTP = http, [SERVER ADDRESS], [GENERATED PORT], username = 用户名, password = 密码
ProxyHTTPS = https, [SERVER ADDRESS], [GENERATED PORT], username = 用户名, password = 密码
ProxySOCKS5 = socks5, [SERVER ADDRESS], [GENERATED PORT], username = 用户名, password = 密码
ProxySOCKS5TLS = socks5-tls, [SERVER ADDRESS], [GENERATED PORT], username = 用户名, password = 密码, skip-common-name-verify=true
ProxySnell = snell, [SERVER ADDRESS], [GENERATED PORT], psk=[GENERATED PSK], obfs=http
ProxyShadowsocks01 = custom, [SERVER ADDRESS], [GENERATED PORT], chacha20-ietf-poly1305, password, https://raw.githubusercontent.com/ydzydzydz/Rules/master/SSEncrypt/SSEncrypt.module
ProxyShadowsocks02 = ss, [SERVER ADDRESS], [GENERATED PORT], encrypt-method = rc4-md5, password = 密码
```

可选参数：


* 开启 TCP Fast Open

  ```ini
  tfo = true
  ```

* 开启 UDP

  ```ini
  udp-relay = true
  ```

* 开启 MPTCP

  ```ini
  mptcp = true
  ```

利用服务器定义的方式实现的广告通过选择

Ad-Pass 不拦截广告, Ad-Block 直接拒绝, Ad-GIF 返回一个透明像素图
```ini
Ad-Pass = direct
Ad-Block = reject
Ad-GIF = reject-tinygif
```
---
# [Proxy Group]
``该段定义可用的策略组``


**有 4 种策略组类型: “select”,  “url-test”, “fallback” 和 “ssid”**

select: 具体哪个子策略将被使用, 由用户界面上进行选择

ssid: 具体哪个子策略将被使用, 根据 Wi-FI 的 SSID 决定

url-test: 具体哪个子策略将被使用, 通过测试到具体 URL 的访问速度选择

fallback: 具体哪个子策略将被使用, 通过测试到具体 URL 的可用性决定



* 手动选择：Auto, Proxy01, Proxy02, Proxy03
```ini
Proxy = select, Auto, Proxy01 , Proxy02, Proxy03
```
* 根据 Wi-FI 的 SSID 决定：默认策略 Auto, 数据网络策略 ProxyA, 连接到 123 的 Wi-FI 网络策略 ProxyB, 连接到 456 的 Wi-FI 网络策略 ProxyC
```ini
Scene = ssid, default = Auto, cellular = ProxyA, “123” = ProxyB, “456” = ProxyC
```
* 可用性自动测试：包含策略 Proxy01, Proxy02, Proxy03, 测试 url 为 http://www.bing.com,  **选出可用的第一个策略**,测试完成前使用第一个策略
```ini
Video = fallback, Proxy01, Proxy02, Proxy03, url = http://www.bing.com/, evaluate-before-use = true
```

* 延迟自动测试：包含策略 Proxy01,  Proxy02,  Proxy03, 测试 url 为 http://www.bing.com, 600s后上次的测试结果将被抛弃, 比原优选线路的响应时间, 大于100ms的时候, 触发线路变更, 如果某策略在5s后依然没有完成, 放弃该策略。   **选出延迟最低的策略**，测试完成前使用第一个策略
```ini
Auto = url-test, Proxy01, Proxy02, Proxy03, url = http://www.bing.com/, interval = 600s, tolerance = 100ms, timeout = 5s, evaluate-before-use = true
```

以代理服务器的选择模式实现广告的通过选择
```ini
AdBlock = select, Ad-GIF, Ad-Block, Ad-Pass
```
策略组的另一种写法：引用远程或者本地list文件, **本地须将list文件放置在iCloud云盘Surge文件夹中**, [list文件示例](https://raw.githubusercontent.com/ydzydzydz/Rules/master/proxy/all.list)

* 远程list
```ini
AdBlock = select, policy-path = https://raw.githubusercontent.com/ydzydzydz/Rules/master/proxy/ad.list
```
* 本地list
```ini
AdBlock = select, policy-path = ad.list
```

外部策略组默认更新间隔时间为 24h，可自定义

```ini
🚦 Ad-Block = select, policy-path=https://raw.githubusercontent.com/ydzydzydz/Rules/master/conf/zhuangzhuang/proxy/ad.list, update-interval=300
```

[关于策略组的理解](https://github.com/Fndroid/jsbox_script/wiki/%E5%85%B3%E4%BA%8E%E7%AD%96%E7%95%A5%E7%BB%84%E7%9A%84%E7%90%86%E8%A7%A3)

---

# [Rule]
``规则定义部分``

一条规则有三个基础部分:

|类型|值|策略|注释(非必需)|
|----|----|----|----|
|DOMAIN,|www.apple.com,| DIRECT | //注释       |
|DOMAIN-SUFFIX,|apple.com,|DIRECT|//注释|
|DOMAIN-KEYWORD,|apple,|DIRECT|//注释|
|IP-CIDR,|10.0.0.0/8,|DIRECT|//注释|
|GEOIP,|CN,|DIRECT|//注释|
|USER-AGENT,|Instagram*,|ProxyA|//注释|
|URL-REGEX,|^http:\/\/google\\.com,|ProxyA|//注释|
|PROCESS-NAME,|Telegram,| ProxyA | //注释       |
|RULE-SET, |SYSTEM, |DIRECT|//注释|
|AND, |((DOMAIN, abc.com), (USER-AGENT, Surge*)), |DIRECT|//注释|
|OR, |((DOMAIN, abc.com), (USER-AGENT, Surge*)), |DIRECT|//注释|
|NOT, |((DOMAIN, abc.com)), |ProxyA|//注释|
|DEST-PORT, |80, |DIRECT|//注释|
|SRC-IP, |192.168.20.100, |DIRECT|//注释|
|IN-PORT, |6152, |DIRECT|//注释|
|FINAL, | |ProxyA|//注释|

**有三种基于域名的规则: “DOMAIN”,  “DOMAIN-SUFFIX” 和 “DOMAIN-KEYWORD”**
* 如果请求域完全匹配, 则匹配规则。
```ini
DOMAIN, www.apple.com, DIRECT
```
* 如果请求的域与后缀匹配, 则匹配规则。例如:google.com匹配www.google.com, mail.google.com和google.com, 但不匹配content-google.com。
```ini
DOMAIN-SUFFIX, google.com, DIRECT
```
* 如果请求的域包含关键字, 则匹配规则。
```ini
DOMAIN-KEYWORD, apple, DIRECT
```
* 参数: force-remote-dns (默认值: false)
如果某请求被该规则匹配,  且策略不是DIRECT. 那么 DNS 查询将永远在远端代理服务器执行,  即使该请求由 Surge TUN 处理  

```ini
DOMAIN-KEYWORD, google, ProxyHTTP, force-remote-dns
```
**有两种基于IP的规则: “IP-CIDR” ,  “GEOIP”**

* 如果是一个使用域名进行访问的请求, 那么 Surge 将进行 DNS 查询以确认是否应该被该规则匹配. 若 DNS 查询失败, 将放弃规则匹配过程并直接给出错误。
```ini
IP-CIDR, 10.0.0.0/8, DIRECT
```
* OPTIONS: no-resolve:(默认值: false)
如果是一个使用域名进行访问的请求, 跳过该条规则, 不触发 DNS 查询。
```ini
IP-CIDR, 192.168.0.0/16, DIRECT, no-resolve
```
* GeoIP CN, 基于 GeoIP 数据库判断域名和 IP 的归属地
```ini
GEOIP, CN, DIRECT
```

**有两种HTTP规则: “USER-AGENT”, “URL-REGEX”**

HTTP规则用于HTTP请求或HTTPS请求。它不会影响TCP连接。

* USER-AGENT, 如果请求的用户代理匹配, 则匹配规则。通配符*和?都受支持。
```ini
USER-AGENT, Instagram*, DIRECT
```
* URL-REGEX, 如果URL与正则表达式匹配, 则匹配规则。**最新版 Surge 的 URL-REGEX 规则支持 Mitm**
```ini
URL-REGEX, ^http://google\.com, DIRECT
```


* PROCESS-NAME, 可以为指定的进程分配策略, 规则仅适用于Surge Mac, Surge iOShui 忽略了这些规则。
```ini
PROCESS-NAME, Telegram, Proxy
```

**RULESET规则集**

规则集包含多条子规则, 可以是另一个本地 list 文件, 或者是一个 URL（当前版本中固定为每 24 小时进行一次自动更新）

* 内置了两个规则集：[SYSTEM](https://raw.githubusercontent.com/ydzydzydz/Rules/master/special/system.list)  和 [LAN](https://raw.githubusercontent.com/ydzydzydz/Rules/master/special/lan.list)
```ini
RULE-SET, SYSTEM, DIRECT
RULE-SET, LAN, DIRECT
```
* list 文件是一个纯文本文件, 每一行为一个规则, **最后不可写上策略名,** [list文件示例](https://raw.githubusercontent.com/ydzydzydz/Rules/master/special/apple.list)   
```ini
RULE-SET, https://raw.githubusercontent.com/ydzydzydz/Rules/master/special/apple.list, Proxy
```

外部规则集默认更新间隔时间为 24h，可自定义

```ini
RULE-SET,https://raw.githubusercontent.com/ydzydzydz/Rules/master/special/telegram.list,🛩 Telegram,update-interval=300
```

**逻辑规则三种：“AND”,  “OR”和“NOT”**

可以组合多个子规则, 且可进行多层嵌套, 用于某些复杂场景的判断
* AND 运算符表示所有子规则都匹配时, 使用该策略。
```ini
AND, ((#Rule1), (#Rule2), (#Rule3)...), Policy
```
* OR 运算符表示任何子规则匹配时, 使用该策略。
```ini
OR, ((#Rule1), (#Rule2), (#Rule3)...), Policy
```
* NOT 运算符表示子规则未匹配时, 使用该策略。
```ini
NOT, ((#Rule1)), Policy
```

**Miscellaneous规则三种:“DEST-PORT”, “SRC-IP”和“IN-PORT”**
* DEST-PORT 如果请求的目标端口匹配, 则规则匹配。
```ini
DEST-PORT, 80, DIRECT
```
* SRC-IP 如果请求的客户端IP地址匹配, 则规则匹配。仅适用于远程机器。
```ini
SRC-IP, 192.168.20.100, DIRECT
```
* IN-PORT 如果请求的传入端口匹配, 则规则匹配。Surge在多个端口上监听时很有用。
```ini
IN-PORT, 6152, DIRECT
```


**Final规则**  
FINAL规则必须在所有其他规则之后编写。它定义了与任何其他规则不匹配的请求的默认策略。

* DNS 查询失败走 Final 规则
```ini
FINAL, Proxy, dns-failed
```

**触发通知**
* 匹配规则时弹出 notification-text 定义的字符串
```ini
AND, ((DOMAIN, raw.githubusercontent.com), (USER-AGENT, Surge*)), DIRECT, notification-text=“规则集更新”, notification-interval=3 //更新提醒
```

---

# [Host]

``该段定义本地 DNS 记录``

该功能等同于 /etc/hosts, 加上了泛解析和别名支持。
```ini
*.taobao.com = server:223.5.5.5
*.jd.com = server:223.5.5.5
*.tmall.com = server:223.5.5.5
```

---

# [URL Rewrite]
``该段定义针对 HTTP 请求的 URL 重定向规则``

**Header模式**
* Surge将修改Header, 并在必要时将请求重定向到另一台主机。客户端不会注意到这个重定向操作。
```ini
^http://www\.google\.cn http://www.google.com header
```

**302模式**
* Surge只会返回302重定向响应。如果启用了主机名的MitM, 则可以重定向HTTPS请求。
```ini
^http://yachen\.com https://yach.me 302
```

**Reject模式**
* 如果模式匹配, 则拒绝请求。替换参数将被忽略。如果启用了主机名的MitM, 将拒绝HTTPS请求。
```ini
^http://ad\.com/ad\.png _ reject
```
---

# [Header Rewrite]

``重定向HTTP请求或者篡改请求Header``

**header-add**
* 为请求头添加一个新的header line，即使header line已存在
```ini
^http://example.com header-add DNT 1
​
Before:
GET /index.html HTTP/1.1
Host: example.com
Connection: keep-alive
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_4) AppleWebKit/603.1.30 (KHTML, like Gecko) Version/10.1 Safari/603.1.30
Accept-Language: en-us
Accept-Encoding: gzip, deflate
​
After:
GET /index.html HTTP/1.1
Host: example.com
Connection: keep-alive
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_4) AppleWebKit/603.1.30 (KHTML, like Gecko) Version/10.1 Safari/603.1.30
Accept-Language: en-us
Accept-Encoding: gzip, deflate
DNT: 1
```

**header-del**
* 从请求头中删除header line
```ini
^http://example.com header-del DNT
​
Before:
GET /index.html HTTP/1.1
Host: example.com
Connection: keep-alive
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_4) AppleWebKit/603.1.30 (KHTML, like Gecko) Version/10.1 Safari/603.1.30
Accept-Language: en-us
Accept-Encoding: gzip, deflate
DNT: 1
​
After:
GET /index.html HTTP/1.1
Host: example.com
Connection: keep-alive
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_4) AppleWebKit/603.1.30 (KHTML, like Gecko) Version/10.1 Safari/603.1.30
Accept-Language: en-us
Accept-Encoding: gzip, deflate
```

**header-replace**
* 替换请求头，如果请求头字段不存在，则不会发生任何事情。
```ini
^http://example.com header-replace DNT 1
​
Before:
GET /index.html HTTP/1.1
Host: example.com
Connection: keep-alive
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_4) AppleWebKit/603.1.30 (KHTML, like Gecko) Version/10.1 Safari/603.1.30
Accept-Language: en-us
Accept-Encoding: gzip, deflate
DNT: 0
​
After:
GET /index.html HTTP/1.1
Host: example.com
Connection: keep-alive
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_4) AppleWebKit/603.1.30 (KHTML,  like Gecko) Version/10.1 Safari/603.1.30
Accept-Language: en-us
Accept-Encoding: gzip, deflate
DNT: 1
```

如果要在请求头字段存在时添加或替换header line，可以一起使用header-add和header-del。
```ini
^http://example.com header-del DNT
^http://example.com header-add DNT 1
```

---

# [SSID Setting]
* 连接到 Apple Store 的 Wi-Fi 网络时 Surge 暂停工作  
需要 Web 验证登录的 Wi-Fi 网络以及路由器已经科学上网的 Surge 挂起
```ini
“Apple Store” suspend=true
```
* 计费网络模式, 当连接到热点名为 iPhone X 的网络时自动切换为计费模式
```ini
“iPhone X” cellular-mode=true
```

---

# [MITM]

``Surge可以通过MitM解密HTTPS通信``

跳过服务端证书验证
```ini
skip-server-cert-verify = true
```
用于TCP连接
```ini
tcp-Connection = true
```
~~自动旁路~~（最新版已经删掉了）

```ini
auto-bypass = on
```

主机名（默认只解密`443端口`，使用`suffix:0`为主机名上的所有端口启用Mitm，使用`suffix:port`为主机名上的特定端口启用Mitm）

```ini
hostname = api.chelaile.net.cnn.cn
```
最新版 Surge 的 URL-REGEX 规则支持 Mitm，可以通过添加前缀`-`排除域名

```ini
hostname = -*.apple.com,-*.icloud.com,*
```

证书生成器将帮助您生成用于调试的新CA证书, 并使证书受到系统的信任。

它可以在Surge Dashboard (Mac版)和Surge iOS配置编辑器中使用。

这个证书是本地生成的, 只会保存在配置文件和系统密钥链中。

证书密钥是使用OpenSSL随机生成的。

还可以使用现有的CA证书。用密码将证书导出到PKCS#12格式(.p12)。

请注意, 由于系统限制, 密码不能为空。使用“base64”命令对base64字符串进行编码, 并将这些设置附加到配置文件中。
```ini
ca-passphrase = 4B676386
ca-p12 = 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
```
**安装证书**
* 配置根证书-安装证书-设置-通用描述文件与设备管理-安装
* **设置-通用-关于本机-证书信任设置-信任**   

**强迫症患者[解决Surge证书未验证](http://zhuangzhuang.cf/2018-11-26/qianming/)**

---

# [Snell Server]

`使用Surge Mac作为Snell代理服务器（从3.1.0版本开始）。`

```ini
interface = 0.0.0.0
port = 6160
psk = RANDOM_KEY_HERE
obfs = off
```

---

# [Script]

`使用 JavaScript 来对 response body 进行修改。`

```ini
[Script]
http-response .* script-path=anti-spoiler.js
```

每一行配置分为三个部分，第一部分为脚本类型，目前仅支持 `http-response`； 第二部分为针对请求 URL 的正则表达式； 第三部分为参数表，使用半角逗号分隔，参数有：

+ script-path：JS 脚本的路径，可以是 URL、相对路径或绝对路径（仅限 macOS），必填。
+ script-update-interval：JS 脚本的更新间隔，仅当使用 URL 时生效，选填，默认值为 24 小时。
+ max-size：最大允许进行修改的 body 大小，单位为字节，选填，默认值为 524288 (512KB)。

由于进行 script 修改会需要 Surge 先将 response body 完全下载后再进行处理，如果遇到了较大的数据将导致内存占用量暴增，Surge iOS 受系统内存限制在该情况下极易被直接终止。

当返回的数据长度超过 max-size 设定值后，Surge 将放弃对该请求执行脚本并回退到 passthrough 模式。

**编写脚本**

Surge 会向 JSVM 上下文传入以下全局变量：

+ body[String]: 原始 response body
+ status[Number]: HTTP 状态码
+ method[String]: HTTP 请求方法
+ url[String]: URL 地址

Surge 将使用脚本的最后一行运行结果作为返回值，返回值约定如下：

+ String 类型: 将使用该结果作为新的 response body
+ Null: 终止该请求
+ undefined: 不对请求进行修改

一个简单的样例

```javascript
var obj = JSON.parse(body);     // 对 response body 进行 JSON 解析得到 Object
obj['surge'] = 'OK';            // 增加 'surge' 字段
JSON.stringify(obj);            // 进行 JSON 编码并作为结果返回
```

另一个样例，将全文查找所有的文字进行反剧透 [https://gist.github.com/Blankwonder](https://gist.github.com/Blankwonder/72fcdd46d1d9148f5461c6b59d859551)

**其他**

+ 受 JavaScript 语言限制，目前仅支持对 UTF-8 编码的 response body 执行脚本，如果 response body 的二进制数据无法进行 UTF-8 解码，将跳过脚本直接返回。
+ 默认情况下，每次执行脚本时将使用一个干净的 JVM 上下文，如果需要可配置

```ini
[General]
shared-jvm-context=true
```

该模式下所有脚本将共享上下文，可以使用全局变量共享数据。

+ 可使用 console.log 将日志输出到 Surge 的日志中，方便调试。

+ Dashboard 中抓到的 response header 和 response body 为修改后的结果，在 Notes 中可看到脚本的执行情况。

[查看官网](https://manual.nssurge.com/scripting/http-response.html)

---
# 大佬们的规则：

| 项目地址                                                     | 捷径                                                         | JSBOX                                                        |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| [Blankwonder/surge-list](https://github.com/Blankwonder/surge-list) |                                                              |                                                              |
| [Choler/Surge](https://github.com/Choler/Surge)              | [Surge](https://www.icloud.com/shortcuts/6da9a6c09618464d85c11580d81b1e51) |                                                              |
| [ConnersHua/Profiles](https://github.com/ConnersHua/Profiles) | [Surge2](https://www.icloud.com/shortcuts/0913876d77d647f7b229903edb3a9be0)/[Surge3](https://www.icloud.com/shortcuts/bbb973be542a4c4bba94101f2ae16bcf) |                                                              |
| [Hackl0us/SS-Rule-Snippet](https://github.com/Hackl0us/SS-Rule-Snippet) | [Surge2](https://www.icloud.com/shortcuts/eb5f7930bf8e414993452c3cae1906ca)/[Surge3](https://www.icloud.com/shortcuts/5dee27f365974ba7bec536adc543b24d) |                                                              |
| [lhie1/Rules](https://github.com/lhie1/Rules)                |                                                              | [Rules-lhie1](https://xteko.com/redir?name=Rules-lhie1&url=https://raw.githubusercontent.com/Fndroid/jsbox_script/master/Rules-lhie1/.output/Rules-lhie1.box) |
| [scomper/surge-list](https://github.com/scomper/surge-list)  |                                                              |                                                              |
| [tudi1909/Surge_iOS_Rules](https://github.com/tudi1909/Surge_iOS_Rules) |                                                              |                                                              |
| [tudi1909/Surge_macOS_Rules](https://github.com/tudi1909/Surge_macOS_Rules) |                                                              |                                                              |
| Neurogram                                                    |                                                              | [Surge³](https://xteko.com/redir?name=Surge³&url=https%3A%2F%2Fraw.githubusercontent.com%2FNeurogram-R%2FJSBox%2Fmaster%2FSurge%25c2%25b3.box&icon=icon_053.png&version=0.7.4&author=Neurogram) |
| [huanz/surge-hosts](https://github.com/huanz/surge-hosts)    |                                                              |                                                              |
| [XinSSS/Conf-for-Surge-Shadowrocket](https://github.com/XinSSS/Conf-for-Surge-Shadowrocket) |                                                              |                                                              |
| [h2y/Shadowrocket-ADBlock-Rules](https://github.com/h2y/Shadowrocket-ADBlock-Rules) |                                                              |                                                              |



# 如何自己写配置

推荐神机大佬的：[Surge 使用手册](https://chua.pro/more/subject-index/surge-manual/)

---

# 参考：

[scomper/Surge](https://github.com/scomper/Surge/blob/master/surge3.conf.ini)  
[Surge 用户手册](https://manual.nssurge.com/)

# 反馈：

[ZHUANGZHUANG](https://t.me/YDZ123456)

